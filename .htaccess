# ========================================
# SECURITY HEADERS
# Item 63/78: Server-side security headers
# For Apache servers
# ========================================

# ====================================
# PREVENT CLICKJACKING
# ====================================

# X-Frame-Options: Prevents your site from being embedded in iframes
# DENY = Never allow framing
# SAMEORIGIN = Only allow framing from same origin
<IfModule mod_headers.c>
    Header always set X-Frame-Options "SAMEORIGIN"
</IfModule>

# ====================================
# PREVENT MIME-SNIFFING
# ====================================

# X-Content-Type-Options: Prevents browsers from MIME-sniffing
# nosniff = Browser must respect declared Content-Type
<IfModule mod_headers.c>
    Header always set X-Content-Type-Options "nosniff"
</IfModule>

# ====================================
# REFERRER POLICY
# ====================================

# Referrer-Policy: Controls how much referrer information is sent
# strict-origin-when-cross-origin = Full URL for same-origin, origin only for cross-origin
<IfModule mod_headers.c>
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
</IfModule>

# ====================================
# CONTENT SECURITY POLICY
# ====================================

# CSP: Controls what resources can be loaded
<IfModule mod_headers.c>
    Header always set Content-Security-Policy "\
        default-src 'self'; \
        script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.googletagmanager.com https://www.google-analytics.com https://cdn.jsdelivr.net https://fonts.googleapis.com; \
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; \
        font-src 'self' https://fonts.gstatic.com; \
        img-src 'self' data: https: blob:; \
        connect-src 'self' https://www.google-analytics.com https://analytics.google.com; \
        frame-src 'self' https://www.youtube.com; \
        object-src 'none'; \
        base-uri 'self'; \
        form-action 'self'; \
        upgrade-insecure-requests"
</IfModule>

# ====================================
# XSS PROTECTION (Legacy)
# ====================================

# X-XSS-Protection: Legacy header for older browsers
# 1; mode=block = Enable XSS filter and block page if attack detected
<IfModule mod_headers.c>
    Header always set X-XSS-Protection "1; mode=block"
</IfModule>

# ====================================
# STRICT TRANSPORT SECURITY (HSTS)
# ====================================

# Strict-Transport-Security: Forces HTTPS for 1 year
# max-age=31536000 = 1 year in seconds
# includeSubDomains = Apply to all subdomains
# preload = Allow inclusion in browser preload lists
<IfModule mod_headers.c>
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" env=HTTPS
</IfModule>

# ====================================
# PERMISSIONS POLICY
# ====================================

# Permissions-Policy: Controls browser features and APIs
<IfModule mod_headers.c>
    Header always set Permissions-Policy "\
        geolocation=(self), \
        microphone=(), \
        camera=(), \
        payment=(), \
        usb=(), \
        magnetometer=(), \
        gyroscope=(), \
        accelerometer=()"
</IfModule>

# ====================================
# CROSS-ORIGIN POLICIES
# ====================================

# Cross-Origin-Embedder-Policy
<IfModule mod_headers.c>
    Header always set Cross-Origin-Embedder-Policy "require-corp"
</IfModule>

# Cross-Origin-Opener-Policy
<IfModule mod_headers.c>
    Header always set Cross-Origin-Opener-Policy "same-origin"
</IfModule>

# Cross-Origin-Resource-Policy
<IfModule mod_headers.c>
    Header always set Cross-Origin-Resource-Policy "same-origin"
</IfModule>

# ====================================
# ADDITIONAL SECURITY
# ====================================

# Remove Server signature
<IfModule mod_headers.c>
    Header unset Server
    Header unset X-Powered-By
</IfModule>

# Disable directory browsing
Options -Indexes

# Prevent access to sensitive files
<FilesMatch "^\.">
    Require all denied
</FilesMatch>

<Files ~ "^(\.htaccess|\.htpasswd|\.env|\.git|package\.json|composer\.json)$">
    Require all denied
</Files>

# ====================================
# FORCE HTTPS REDIRECT
# ====================================

# Redirect all HTTP to HTTPS
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}/$1 [R=301,L]
</IfModule>

# ====================================
# COMPRESSION
# ====================================

# Enable GZIP compression
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
</IfModule>

# ====================================
# CACHE CONTROL
# ====================================

# Browser caching for static files
<IfModule mod_expires.c>
    ExpiresActive On
    
    # Images
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType image/x-icon "access plus 1 year"
    
    # CSS and JavaScript
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType application/x-javascript "access plus 1 month"
    
    # Fonts
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType font/ttf "access plus 1 year"
    ExpiresByType font/otf "access plus 1 year"
    
    # HTML
    ExpiresByType text/html "access plus 0 seconds"
</IfModule>

# ====================================
# ANTI-SCRAPING PROTECTION
# Item 79: Protection contre scraping
# ====================================

# Block common scraping user agents
<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # Block bad bots
    RewriteCond %{HTTP_USER_AGENT} ^.*(bot|crawl|spider|scrape|curl|wget|python|java|httpclient|harvest|extract|grab|suck|reaper|collector).*$ [NC]
    RewriteRule .* - [F,L]
    
    # Block empty user agents
    RewriteCond %{HTTP_USER_AGENT} ^$ [OR]
    RewriteCond %{HTTP_USER_AGENT} ^-$
    RewriteRule .* - [F,L]
    
    # Rate limiting by IP (100 requests per minute)
    RewriteCond %{ENV:RATE_LIMITED} =1
    RewriteRule .* - [R=429,L]
</IfModule>

# Prevent hotlinking (linking images from other sites)
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteCond %{HTTP_REFERER} !^$
    RewriteCond %{HTTP_REFERER} !^https?://(www\.)?resqplus\.com [NC]
    RewriteRule \.(jpg|jpeg|png|gif|svg|webp|ico)$ - [F,L]
</IfModule>

# Block access to sensitive files
<FilesMatch "\.(env|log|bak|sql|sh|json|md|yml|yaml)$">
    Require all denied
</FilesMatch>

# Prevent downloading of source files
<FilesMatch "\.(js|css)$">
    <IfModule mod_headers.c>
        Header set X-Content-Type-Options "nosniff"
        Header set Cache-Control "public, max-age=2592000"
    </IfModule>
</FilesMatch>

# Add copyright notice to responses
<IfModule mod_headers.c>
    Header set X-Copyright "Â© 2024 RESQ+. All rights reserved."
    Header set X-Content-Protection "This content is protected. Unauthorized copying is prohibited."
</IfModule>
